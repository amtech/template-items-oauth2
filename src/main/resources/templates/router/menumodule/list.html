<!-- row -->
<div class="row">

    <div id="menu-module-toolbar" class="form-inline">
        <a id="add-menumodule" class="btn btn-info btn-sm"><i class="fa fa-plus-square-o"></i> 添加</a>
        <button id="edit-menumodule" class="btn btn-warning btn-sm"><i class="fa fa-edit"></i> 编辑</button>
        <button id="delete-menumodule" class="btn btn-danger btn-sm"><i class="fa fa-minus-square-o"></i> 删除</button>
        &nbsp;
        <label id="menu-module-search-control" class="checkbox-inline">
            <input type="checkbox" class="checkbox style-3">
            <span>显示搜索控件</span>
        </label>
    </div>
    <!-- NEW WIDGET START -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <table id="menu-module-table">
            <thead>
            <tr>
                <th data-checkbox="true"></th>
                <th data-field="id"
                    data-visible="false"
                    data-sortable="true"
                    data-searchable="true"
                    data-width="150"
                    data-title="菜单ID"
                    data-align="center"></th>

                <th data-field="name"
                    data-sortable="true"
                    data-title="菜单模块名称"
                    data-searchable="true"
                    data-filter-control="input"
                    data-filter-control-placeholder="输入菜单模块名"
                    data-align="center"></th>

                <th data-field="systemCode"
                    data-sort-name="system_code"
                    data-sortable="true"
                    data-search-formatter="false"
                    data-title="系统编码"
                    data-filter-control="input"
                    data-filter-control-placeholder="输入系统编码"
                    data-align="center"></th>

                <th data-field="enabled"
                    data-formatter="enabledFormatter"
                    data-title="是否可用"
                    data-filter-control="select"
                    data-filter-data="url:/common/select"
                    data-align="center"></th>

                <th data-field="updateUsername"
                    data-visible="false"
                    data-title="更新人"
                    data-align="center"></th>

                <th data-field="updateDate"
                    data-formatter="date_formatter"
                    data-visible="false"
                    data-title="更新时间"
                    data-align="center"></th>

                <th data-field="createUsername"
                    data-visible="false"
                    data-title="创建人"
                    data-align="center"></th>

                <th data-field="createDate"
                    data-formatter="date_formatter"
                    data-visible="false"
                    data-title="创建时间"
                    data-align="center"></th>

                <th data-field="orderIndex"
                    data-sort-name="order_index"
                    data-sortable="true"
                    data-title="排序"
                    data-align="center"></th>

                <th data-field="remark"
                    data-title="备注"
                    data-align="center"></th>

            </tr>
            </thead>
        </table>
    </article>
    <!-- WIDGET END -->

</div>


<div id="menu-module-operation" class="hidden">
    <!--添加弹出的窗口-->
    <div id="add_menumodule_dialog">
        <section id="add-menumodule-app" class="row">
            <form id="add-menumodule-form" class="form-horizontal" @submit.prevent="handleSubmit_add" method="post">
                <fieldset>
                    <!--名称-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                        <label class="col-md-2 control-label">名称</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text"
                                   v-model="menumodule.name">
                            <div class="note-error margin-bottom-0"
                                 v-bind:class="{ 'has-error text-danger margin-top-10': error.nameError }">
                                {{error.nameErrorMsg}}
                            </div>
                        </div>
                    </div>

                    <!--系统编码-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                        <label class="col-md-2 control-label">系统编码</label>
                        <div class="col-md-10">
                            <select class="form-control" v-model="menumodule.systemCode.selected"
                                    id="menumodule-selector-add">
                            </select>
                        </div>
                    </div>

                    <!--是否可用-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.enabledError }">
                        <label class="col-md-2 control-label">是否可用</label>
                        <div class="col-md-10">
                            <label class="radio radio-inline">
                                <input type="radio" v-model="menumodule.enabled"
                                       class="radiobox style-0"
                                       v-bind:value="true" checked>
                                <span>是</span>
                            </label>
                            <label class="radio radio-inline">
                                <input type="radio" v-model="menumodule.enabled"
                                       class="radiobox style-0"
                                       v-bind:value="false" checked>
                                <span>否</span>
                            </label>
                            <div class="note-error margin-bottom-0"
                                 v-bind:class="{ 'has-error text-danger margin-top-10': error.enabledError }">
                                {{error.enabledErrorMsg}}
                            </div>
                        </div>
                    </div>
                    <!--排序-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.orderError }">
                        <label class="col-md-2 control-label">排序</label>
                        <div class="col-md-10">
                            <input class="form-control" type="number"
                                   v-model="menumodule.orderIndex">
                            <div class="note-error margin-bottom-0"
                                 v-bind:class="{ 'has-error text-danger margin-top-10': error.orderError }">
                                {{error.orderErrorMsg}}
                            </div>
                        </div>
                    </div>
                    <!--备注-->
                    <div class="form-group">
                        <label class="col-md-2 control-label">备注</label>
                        <div class="col-md-10">
                            <input class="form-control" placeholder="备注信息（选填）" type="text" v-model="menumodule.remark">
                        </div>
                    </div>

                </fieldset>
                <button id="add" type="submit" class="hidden"></button>
            </form>
        </section>
    </div>

    <!--编辑弹出窗口-->
    <div id="edit_menumodule_dialog">
        <section id="edit-menumodule-app" class="row">
            <form id="edit-menumodule-form" class="form-horizontal" @submit.prevent="handleSubmit_edit" method="post">
                <fieldset>
                    <!--名称-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                        <label class="col-md-2 control-label">名称</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text"
                                   v-model="menumodule.name">
                            <div class="note-error margin-bottom-0"
                                 v-bind:class="{ 'has-error text-danger margin-top-10': error.nameError }">
                                {{error.nameErrorMsg}}
                            </div>
                        </div>
                    </div>

                    <!--系统编码-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                        <label class="col-md-2 control-label">系统编码</label>
                        <div class="col-md-10">
                            <select class="form-control" v-model="menumodule.systemCode.selected"
                                    id="menumodule-selector-edit"
                                    data-live-search="true">
                            </select>
                        </div>
                    </div>

                    <!--是否可用-->
                    <div class="form-group" v-bind:class="{ 'has-error': error.enabledError }">
                        <label class="col-md-2 control-label">是否可用</label>
                        <div class="col-md-10">
                            <label class="radio radio-inline">
                                <input type="radio" v-model="menumodule.enabled"
                                       class="radiobox style-0"
                                       v-bind:value="true" checked>
                                <span>是</span>
                            </label>
                            <label class="radio radio-inline">
                                <input type="radio" v-model="menumodule.enabled"
                                       class="radiobox style-0"
                                       v-bind:value="false" checked>
                                <span>否</span>
                            </label>
                            <div class="note-error margin-bottom-0"
                                 v-bind:class="{ 'has-error text-danger margin-top-10': error.enabledError }">
                                {{error.enabledErrorMsg}}
                            </div>
                        </div>
                    </div>
                    <!--备注-->
                    <div class="form-group">
                        <label class="col-md-2 control-label">备注</label>
                        <div class="col-md-10">
                            <input class="form-control" placeholder="备注信息（选填）" type="text" v-model="menumodule.remark">
                        </div>
                    </div>

                </fieldset>
                <button id="edit" type="submit" class="hidden"></button>
            </form>
        </section>
    </div>
</div>


<script type="text/javascript">

    pageSetUp();

    // page_function
    var page_function = function () {


        var $table = $("#menu-module-table");

        //搜索控件显影的监听事件
        $("#menu-module-search-control").on("click", function () {
            window.__customControls___ = $("input[type=checkbox]").prop("checked");
            TF.reInitTable($table, {
                url: "/menumodule/api/list",
                toolbar: '#menu-module-toolbar',
                queryParams: query_params,
                filterControl: true
            })
        });

        //设置表格的搜索参数
        var query_params = function (params) {
            return {
                limit: params.limit,
                offset: params.offset,
                order: params.order,
                sort: params.sort,
                name: $("input.bootstrap-table-filter-control-name").val(),
                systemCodeName: $("input.bootstrap-table-filter-control-systemCode").val()
            };
        };

        //加载表格
        TF.initTable($table, {
            url: "/menumodule/api/list",
            toolbar: '#menu-module-toolbar',
            queryParams: query_params
        });

        var app = new Vue({
            el: "#menu-module-operation",
            data: {
                menumodule: {
                    id: '',
                    name: '',
                    systemCode: {
                        selected: '',
                        options: []
                    },
                    enabled: false,
                    orderIndex: null,
                    remark: ''
                },
                error: {
                    nameError: false,
                    nameErrorMsg: '',
                    orderError: false,
                    orderErrorMsg: ''
                }
            },
            computed: {
                errors: function () {
                    return this.$vuerify.$errors // 错误信息会在 $vuerify.$errors 内体现
                }
            },
            methods: {
                handleSubmit_add: function () {
                    this.$vuerify.clear()//清空之前的验证结果信息
                    var check_result = this.$vuerify.check()// 手动触发校验所有数据
                    var $errs = this.$vuerify.$errors
                    app.error.nameError = Boolean($errs.name)
                    app.error.nameErrorMsg = $errs.name
                    app.error.orderError = Boolean($errs.orderIndex)
                    app.error.orderErrorMsg = $errs.orderIndex

                    if (!check_result) {
                        TF.show_error_message("错误消息提示", "请修正表单错误信息之后再提交", 3000)
                    } else {
                        var params = new URLSearchParams();
                        var datas = app.menumodule

                        for (var data in datas) {
                            if (data === "systemCode")
                                continue;
                            params.append(data, datas[data])
                        }
                        params.append("systemCode", app.menumodule.systemCode.selected);
                        axios.post('/menumodule/api/add', params)
                            .then(function (response) {
                                if (response.data.code == TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    setTimeout(function () {
                                        $table.bootstrapTable('refresh');
                                    }, 1000)
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })
                            .catch(function (error) {
                                TF.show_error_msg(error.response.data.message)
                            });
                    }
                    return false;
                },
                handleSubmit_edit: function () {
                    this.$vuerify.clear();//清空之前的验证结果信息
                    var check_result = this.$vuerify.check();// 手动触发校验所有数据
                    var $errs = this.$vuerify.$errors;

                    app.error.nameError = Boolean($errs.name)
                    app.error.nameErrorMsg = $errs.name
                    app.error.orderError = Boolean($errs.orderIndex)
                    app.error.orderErrorMsg = $errs.orderIndex

                    if (!check_result) {
                        TF.show_error_message("错误消息提示", "请修正表单错误信息之后再提交", 3000)
                    } else {
                        var params = new URLSearchParams();
                        var datas = app.menumodule;
                        for (var data in datas) {
                            if (data === "systemCode") {
                                continue;
                            }
                            params.append(data, datas[data])
                        }
                        params.append("systemCode", datas.systemCode.selected)
                        axios.post('/menumodule/api/doEdit', params)
                            .then(function (response) {
                                if (response.data.code === TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    $("#edit_menumodule_dialog").dialog("close");
                                    $table.bootstrapTable('refresh');
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })
                            .catch(function (error) {
                                TF.show_error_msg(error.response.data.message)
                            });
                    }
                    return false;
                }
            },
            vuerify: {
                name: {
                    test: function () {
                        return String(app.menumodule.name).length >= 2
                    },
                    message: '名字长度不能为空且不能过短'
                },
                orderIndex: {
                    test: function () {
                        return !isNaN(app.menumodule.orderIndex)
                    },
                    message: '不能为空且必须为数字'
                },
            }
        });

        //监听添加事件
        $("#add-menumodule").click(function () {
            $("#add_menumodule_dialog").dialog('open');
            app.menumodule.id = "";
            app.menumodule.name = "";
            app.menumodule.enabled = false;
            app.menumodule.orderIndex = "0";
            app.menumodule.remark = "";
            return false;
        });

        $('#add_menumodule_dialog').dialog({
            autoOpen: false,
            width: 600,
            resizable: true,
            modal: true,
            title: "<div class='widget-header'><h4><i class='icon-ok'></i> 添加菜单模块</h4></div>",
            buttons: [{
                html: "<i class='fa fa-plus-square-o'></i>&nbsp; 确定",
                "class": "btn btn-info",
                click: function () {
                    $("#add").trigger("click");
                    $(this).dialog("close");
                    $table.bootstrapTable("refresh");
                }
            }, {
                html: "<i class='fa fa-times'></i>&nbsp; 取消",
                "class": "btn btn-default",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        });

        //监听编辑按钮事件
        $("#edit-menumodule").click(function () {

            var ss = $table.bootstrapTable('getSelections');
            if (ss.length === 1) {

                var res = ss[0];
                $('#edit_menumodule_dialog').dialog('open');
                app.menumodule.id = res.id;
                app.menumodule.systemCode.selected = res.systemCode;
                app.menumodule.name = res.name;
                app.menumodule.enabled = res.enabled;
                app.menumodule.orderIndex = res.orderIndex;
                app.menumodule.remark = res.remark;
            } else {
                TF.show_error_message("错误选择", "只能对一条数据进行编辑")
            }
            return false;
        });

        $('#edit_menumodule_dialog').dialog({
            autoOpen: false,
            width: 600,
            resizable: true,
            modal: true,
            title: "<div class='widget-header'><h4><i class='icon-ok'></i> 编辑菜单</h4></div>",
            buttons: [{
                html: "<i class='fa fa-plus-square-o'></i>&nbsp; 确定",
                "class": "btn btn-info",
                click: function () {
                    $("#edit").trigger("click");
                }
            }, {
                html: "<i class='fa fa-times'></i>&nbsp; 取消",
                "class": "btn btn-default",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        });

        //监听删除按钮事件
        $("#delete-menumodule").click(function () {
            var ss = $table.bootstrapTable('getSelections');
            if (ss.length == 0) {
                TF.show_error_message("错误选择", "请至少选择一行数据进行删除")
            } else {
                $.SmartMessageBox({
                    title: "<i class='fa fa-minus-square-o' style='color:red'></i> 删除角色数据?",
                    content: $this.data('reset.msg') || "确认要删除角色数据?",
                    buttons: '[取消][确定]'
                }, function (ButtonPressed) {
                    if (ButtonPressed == "确定") {
                        var ids = "";
                        for (var i = 0; i < ss.length; i++) {
                            ids += ss[i].id + ",";
                        }
                        ids = ids.substr(0, ids.length - 1);//去除最后一个逗号
                        axios.post("/menumodule/api/delete?id=" + ids)
                            .then(function (response) {
                                if (response.data.code == TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    setTimeout(function () {
                                        $table.bootstrapTable("refresh");
                                    }, 1000)
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })

                    }
                })
            }
        });

        //监听搜索按钮事件
        $("#search").click(function () {
            var opt = {
                url: "/menumodule/api/list",
                silent: true,
                query: {
                    name: $("input[name=name]").val(),
                    systemCodeName: $("input[name=systemCodeName]").val(),
                    enabled: $("#enabled_select").val()
                }
            }
            $table.bootstrapTable('refresh', opt);
        });

        //获取下拉框内容
        axios.post('/oauth2/system-module/api/find/modules/enabled', {})
            .then(function (response) {
                if (response.data.length > 0) {
                    app.menumodule.systemCode = response.data;
                    var $selectSystemCode = app.menumodule.systemCode;
                    app.menumodule.systemCode.selected = $selectSystemCode[0].systemCode;//默认给下拉菜单选中第一个
                    for (var i = 0; i < $selectSystemCode.length; i++) {
                        $('#menumodule-selector-add,#menumodule-selector-edit').append("<option value=" + $selectSystemCode[i].systemCode + ">" + $selectSystemCode[i].systemCode + "</option>");
                    }
                }
            })
            .catch(function (error) {
                TF.show_error_msg(error.response.data.message)
            });
    };


    // load related plugins
    loadScript("/static/js/libs/vue/axios.min.js", function () {
        loadScript("/static/js/libs/vue/vuerify.min.js", function () {
            loadScript("/static/js/libs/vue/url-search-params.min.js", page_function())
        })
    })
</script>

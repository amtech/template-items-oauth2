<style type="text/css">
    .dl {
        display: inline-block;
    }

    .dl > .checkbox > input[type=checkbox] {
        margin-left: 10px;
    }
</style>
<div id="res_module_dialog" class="hidden">
    <!--添加弹出的窗口-->
    <div id="add_res_module_dialog">
        <form class="form-horizontal" @submit.prevent="handleSubmit_add" method="post">
            <fieldset>
                <!--名称-->
                <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                    <label class="col-md-2 control-label">名称</label>
                    <div class="col-md-10">
                        <input class="form-control" type="text" v-model="resModule.name">
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.nameError }">
                            {{error.nameErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--是否可用-->
                <div class="form-group" v-bind:class="{ 'has-error': error.enabledError }">
                    <label class="col-md-2 control-label">是否可用</label>
                    <div class="col-md-10">
                        <label class="radio radio-inline">
                            <input type="radio" v-model="resModule.enabled"
                                   class="radiobox style-0"
                                   v-bind:value="true" checked>
                            <span>是</span>
                        </label>
                        <label class="radio radio-inline">
                            <input type="radio" v-model="resModule.enabled"
                                   class="radiobox style-0"
                                   v-bind:value="false" checked>
                            <span>否</span>
                        </label>
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.enabledError }">
                            {{error.enabledErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--系统编码-->
                <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                    <label class="col-md-2 control-label">系统编码</label>
                    <div class="col-md-10">
                        <select id="resource-module-selector-add" @change="selectSystemCode($event)"
                                class="form-control">
                        </select>
                    </div>
                </div>
                <!--排序-->
                <div class="form-group" v-bind:class="{ 'has-error': error.orderIndexError }">
                    <label class="col-md-2 control-label">排序</label>
                    <div class="col-md-10">
                        <input class="form-control" type="number" v-model="resModule.orderIndex">
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.orderIndexError }">
                            {{error.orderIndexErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--备注-->
                <div class="form-group">
                    <label class="col-md-2 control-label">备注</label>
                    <div class="col-md-10">
                        <input class="form-control" placeholder="备注信息（选填）" type="text"
                               v-model="resModule.remark">
                    </div>
                </div>
            </fieldset>
            <button id="add" type="submit" class="hidden"></button>
        </form>
    </div>
    <!--编辑弹出的窗口-->
    <div id="edit_res_module_dialog">
        <form id="edit-res-module-form" class="form-horizontal" @submit.prevent="handleSubmit_edit"
              method="post">
            <fieldset>
                <!--名称-->
                <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                    <label class="col-md-2 control-label">名称</label>
                    <div class="col-md-10">
                        <input class="form-control" type="text"
                               v-model="resModule.name">
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.nameError }">
                            {{error.nameErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--是否可用-->
                <div class="form-group" v-bind:class="{ 'has-error': error.enabledError }">
                    <label class="col-md-2 control-label">是否可用</label>
                    <div class="col-md-10">
                        <label class="radio radio-inline">
                            <input type="radio" v-model="resModule.enabled"
                                   class="radiobox style-0"
                                   v-bind:value="true" checked>
                            <span>是</span>
                        </label>
                        <label class="radio radio-inline">
                            <input type="radio" v-model="resModule.enabled"
                                   class="radiobox style-0"
                                   v-bind:value="false" checked>
                            <span>否</span>
                        </label>
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.enabledError }">
                            {{error.enabledErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--系统编码-->
                <div class="form-group" v-bind:class="{ 'has-error': error.nameError }">
                    <label class="col-md-2 control-label">系统编码</label>
                    <div class="col-md-10">
                        <select class="form-control" v-model="resModule.systemCode.selected"
                                id="resource-module-selector-edit">
                        </select>
                    </div>
                </div>
                <!--排序-->
                <div class="form-group" v-bind:class="{ 'has-error': error.orderIndexError }">
                    <label class="col-md-2 control-label">排序</label>
                    <div class="col-md-10">
                        <input class="form-control" type="number"
                               v-model="resModule.orderIndex">
                        <div class="note-error margin-bottom-0"
                             v-bind:class="{ 'has-error text-danger margin-top-10': error.orderIndexError }">
                            {{error.orderIndexErrorMsg}}
                        </div>
                    </div>
                </div>
                <!--备注-->
                <div class="form-group">
                    <label class="col-md-2 control-label">备注</label>
                    <div class="col-md-10">
                        <input class="form-control" placeholder="备注信息（选填）" type="text"
                               v-model="resModule.remark">
                    </div>
                </div>

            </fieldset>

            <button id="edit" type="submit" class="hidden"></button>
        </form>
    </div>
</div>
<!-- row -->
<div class="row">
    <div id="toolbar" class="form-inline">
        <a href="javascript:void(0);" id="add_dialog_link" class="btn btn-info btn-sm"> <i
                class="fa fa-plus-square-o"></i> 添加
        </a>
        <a href="javascript:void(0);" id="edit_dialog_link" class="btn btn-warning btn-sm"><i
                class="fa fa-pencil-square "></i>
            编辑</a>
        <button id="delete-menu" class="btn btn-danger btn-sm"
                rel="tooltip" data-placement="bottom"
                data-reset-msg="您确定要删除所选项吗？"><i class="fa fa-minus-square-o"></i> 删除
        </button>
        &nbsp;
        <select name="selectEnabled" class="form-control">
            <option value="">是否可用(全选)</option>
            <option value="true">是</option>
            <option value="false">否</option>
        </select>
        <button id="search-menu" class="btn btn-default btn-sm"><i class="fa fa-search"></i> 搜索</button>
    </div>
    <!-- NEW WIDGET START -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <table id="table">
            <thead>
            <tr>
                <th data-checkbox="true"></th>
                <th data-field="id"
                    data-sortable="true"
                    data-width="30"
                    data-title="ID"
                    data-align="center"
                    data-visible="false"></th>

                <th data-field="name"
                    data-sortable="true"
                    data-width="150"
                    data-title="名称"
                    data-filter-control="input"
                    data-filter-control-placeholder="输入名称"
                    data-align="center"></th>

                <th data-field="systemCode"
                    data-sort-name="SYSTEM_CODE"
                    data-sortable="true"
                    data-filter-control="input"
                    data-filter-control-placeholder="输入系统代码"
                    data-width="150"
                    data-title="系统代码"
                    data-align="center"></th>

                <th data-field="enabled"
                    data-title="是否可用"
                    data-formatter="enabledFormatter"
                    data-align="center"></th>

                <th data-field="updateDate"
                    data-sort-name="update_date"
                    data-sortable="true"
                    data-title="修改时间"
                    data-width="160"
                    data-formatter="date_formatter"
                    data-align="center"></th>


                <th data-field="createDate"
                    data-sort-name="create_date"
                    data-sortable="true"
                    data-formatter="date_formatter"
                    data-title="创建日期"
                    data-width="160"
                    data-align="center"></th>

                <th data-field="updateUserName"
                    data-title="修改人"
                    data-align="center"></th>

                <th data-field="createUserName"
                    data-title="创建人"
                    data-align="center"></th>

                <th data-field="orderIndex"
                    data-sort-name="ORDER_INDEX"
                    data-sortable="true"
                    data-title="排序"
                    data-align="center"></th>

                <th data-field="remark"
                    data-sortable="true"
                    data-title="备注"
                    data-align="center"></th>
            </tr>
            </thead>
        </table>
    </article>
    <!-- WIDGET END -->

</div>

<!-- end row -->
<script type="text/javascript">

    pageSetUp();
    var app;
    // page_function
    var page_function = function () {
        var $table = $("#table");
        var query_params = function (params) {
            var temp = {
                limit: params.limit,
                offset: params.offset,
                order: params.order,
                sort: params.sort,
                name: $("input.bootstrap-table-filter-control-name").val(),
                systemCode: $("input.bootstrap-table-filter-control-systemCode").val(),
                selectEnabled: $("select[name=selectEnabled]").val(),
                search: params.search,
            }
            return temp;
        };

        app = new Vue({
            el: "#res_module_dialog",
            data: {
                resModule: {
                    id: '',
                    name: '',
                    enabled: true,
                    orderIndex: null,
                    remark: '',
                    systemCode: {
                        selected: '',
                        options: []
                    }
                },
                error: {
                    nameError: false,
                    nameErrorMsg: '',
                    orderIndexError: false,
                    orderIndexErrorMsg: ''
                }
            },
            computed: {
                errors: function () {
                    return this.$vuerify.$errors // 错误信息会在 $vuerify.$errors 内体现
                }
            },
            methods: {
                handleSubmit_add: function () {
                    this.$vuerify.clear()//清空之前的验证结果信息
                    var check_result = this.$vuerify.check()// 手动触发校验所有数据
                    var $errs = this.$vuerify.$errors
                    app.error.nameError = Boolean($errs.name)
                    app.error.nameErrorMsg = $errs.name
                    app.error.orderIndexError = Boolean($errs.orderIndex)
                    app.error.orderIndexErrorMsg = $errs.orderIndex
                    if (!check_result) {
                        TF.show_error_message("错误消息提示", "请修正表单错误信息之后再提交", 3000)
                    } else {
                        var params = new URLSearchParams();
                        var datas = app.resModule
                        for (var data in datas) {
                            if (data === "systemCode")
                                continue
                            params.append(data, datas[data])
                        }
                        params.append('systemCode', app.resModule.systemCode.selected)
                        axios.post('/resmodule/api/add', params)
                            .then(function (response) {
                                if (response.data.code == TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    setTimeout(function () {
                                        $('#add_res_module_dialog').dialog('close');
                                        $table.bootstrapTable('refresh');
                                    })
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })
                            .catch(function (error) {
                                TF.show_error_msg(error.response.data.message)
                            });
                    }
                    return false;
                },
                handleSubmit_edit: function () {
                    this.$vuerify.clear()//清空之前的验证结果信息
                    var check_result = this.$vuerify.check()// 手动触发校验所有数据
                    var $errs = this.$vuerify.$errors
                    app.error.nameError = Boolean($errs.name)
                    app.error.nameErrorMsg = $errs.name
                    app.error.orderIndexError = Boolean($errs.orderIndex)
                    app.error.orderIndexErrorMsg = $errs.orderIndex
                    if (!check_result) {
                        TF.show_error_message("错误消息提示", "请修正表单错误信息之后再提交", 3000)
                    } else {
                        var params = new URLSearchParams();
                        var datas = app.resModule
                        for (var data in datas) {
                            if (data === "systemCode")
                                continue
                            params.append(data, datas[data])
                        }
                        params.append("systemCode", app.resModule.systemCode.selected)
                        axios.post('/resmodule/api/edit', params)
                            .then(function (response) {
                                if (response.data.code == TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    setTimeout(function () {
                                        $('#edit_res_module_dialog').dialog('close');
                                        $table.bootstrapTable('refresh');
                                    })
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })
                            .catch(function (error) {
                                TF.show_error_msg(error.response.data.message)
                            });
                    }
                    return false;
                }
            },
            vuerify: {
                name: {
                    test: function () {
                        return String(app.resModule.name).length >= 2
                    },
                    message: '名字长度不能为空且不能过短'
                },
                orderIndex: {
                    test: function () {
                        return !isNaN(app.resModule.orderIndex)
                    },
                    message: '不能为空且必须为数字'
                },
            }
        })

        $table.bootstrapTable({
            sidePagination: "server",
            url: "/resmodule/api/list",
            toolbar: '#toolbar',
            showRefresh: true,
            method: 'post',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",//post方式一定得改成这种contentType
            queryParams: query_params,
            height: getHeight(),
            sortName: 'id',//第一次进默认的排序字段
            sortOrder: 'asc',
            idField: "id",
            uniqueId: 'id',
            checkboxHeader: true,
            clickToSelect: true,
            showColumns: true,
            silentSort: false,
            maintainSelected: true,
            striped: true,
            cache: false,
            pagination: true,
            paginationLoop: false,
            pageList: '[10,25,50,150]',
            escape: true,
            filterControl: true,
            filterShowClear: true,
            searchTimeOut: 1000
        });


        // Dialog click
        $('#add_dialog_link').click(function () {
            app.resModule.name = ''
            app.resModule.enabled = true
            app.resModule.orderIndex = 0
            app.resModule.remark = ''
            $('#add_res_module_dialog').dialog('open');
            return false;
        });

        <!--添加dialog-->
        $('#add_res_module_dialog').dialog({
            autoOpen: false,
            width: 500,
            resizable: true,
            modal: true,
            title: "<div class='widget-header'><h4><i class='icon-ok'></i> 添加资源模块</h4></div>",
            buttons: [{
                html: "<i class='fa fa-plus-square-o'></i>&nbsp; 添加",
                "class": "btn btn-info",
                click: function () {
                    $("#add").trigger("click");
                }
            }, {
                html: "<i class='fa fa-times'></i>&nbsp; 取消",
                "class": "btn btn-default",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        });
        <!--编辑dialog-->
        $('#edit_dialog_link').click(function () {
            //判断是否只选中一条信息
            if ($table.bootstrapTable('getSelections').length > 1) {
                TF.show_error_msg("只能选择一条信息进行编辑")
            } else if ($table.bootstrapTable('getSelections').length < 1) {
                TF.show_error_msg("请选择您想要编辑的信息")
            }
            //将选中的信息自动显示
            else {
                //获取选中的对象
                var $editResModule = $table.bootstrapTable('getSelections')[0];
                //把获取到的对象赋值给当前页面上的元素
                app.resModule.id = $editResModule.id
                app.resModule.name = $editResModule.name
                app.resModule.enabled = $editResModule.enabled
                app.resModule.orderIndex = $editResModule.orderIndex
                app.resModule.remark = $editResModule.remark
                app.resModule.systemCode.selected = $editResModule.systemCode
                $('#edit_res_module_dialog').dialog('open');
            }
            return false;
        });
        //编辑dialog
        $('#edit_res_module_dialog').dialog({
            autoOpen: false,
            width: 500,
            resizable: true,
            modal: true,
            title: "<div class='widget-header'><h4><i class='icon-ok'></i> 编辑资源模块</h4></div>",
            buttons: [{
                html: "<i class='fa fa-plus-square-o'></i>&nbsp; 编辑",
                "class": "btn btn-info",
                click: function () {
                    $("#edit").trigger("click");
                }
            }, {
                html: "<i class='fa fa-times'></i>&nbsp; 取消",
                "class": "btn btn-default",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        });
        //调整大小
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        })

        //监听搜索按钮事件
        $("#search-menu").click(function () {
            var opt = {
                url: "/resmodule/api/list",
                silent: true,
            }
            $table.bootstrapTable('refresh', opt);
        })
        //删除菜单
        $("#delete-menu").click(function () {
            if ($table.bootstrapTable('getSelections').length < 1) {
                $.SmartMessageBox({
                    title: "<i class='fa fa-refresh' style='color:green'></i> 删除",
                    content: $this.data('reset-msg') || "至少选择一条信息进行删除！",
                    buttons: '[取消]'
                });
            }
            else {
                $.SmartMessageBox({
                    title: "<i class='fa fa-minus-square-o' style='color:red'></i> 确认要删除吗？",
                    content: $this.data('reset-msg') || "您确定要删除所选择的所有信息吗?",
                    buttons: '[取消][确认]'
                }, function (ButtonPressed) {
                    if (ButtonPressed == "确认" && localStorage) {
                        var _ids = ""
                        for (var i = 0; i < $table.bootstrapTable('getSelections').length; i++) {
                            _ids += $table.bootstrapTable('getSelections')[i].id + ","
                        }
                        _ids = _ids.substr(0, _ids.length - 1);
                        axios.post('/resmodule/api/del?_ids=' + _ids)
                            .then(function (response) {
                                if (response.data.code == TF.STATUS_CODE.SUCCESS) {
                                    layer.msg(response.data.message);
                                    setTimeout(function () {
                                        $table.bootstrapTable("refresh")
                                    })
                                } else {
                                    TF.show_error_msg(response.data.message)
                                }
                            })
                            .catch(function (error) {
                                TF.show_error_msg(error.response.data.message)
                            });
                    }

                });


            }
        })

        //获取下拉框内容
        axios.post('/oauth2/system-module/api/find/modules/enabled', {})
            .then(function (response) {
                if (response.data.length > 0) {
                    app.resModule.systemCode = response.data;
                    var $selectSystemCode = app.resModule.systemCode;
                    app.resModule.systemCode.selected = $selectSystemCode[0].systemCode;
                    for (var i = 0; i < $selectSystemCode.length; i++) {
                        $('#resource-module-selector-add,#resource-module-selector-edit').append("<option value=" + $selectSystemCode[i].systemCode + ">" + $selectSystemCode[i].systemCode + "</option>");
                    }
                }
            })
            .catch(function (error) {
                TF.show_error_msg(error.response.data.message)
            });

        //监听是否可用
        $("select[name=selectEnabled]").change(function () {
            app.resModule.enabled = $(this).find('option:selected').val()
            $table.bootstrapTable("refresh");
        })
    };

    //选择下拉框赋值给selected 因为vue下拉框不能绑定
    function selectSystemCode(e) {
        app.resModule.systemCode.selected = e.target.value
    }

    //获取高度
    function getHeight() {
        return $(window).height() - $('header').outerHeight(true)
            - $('div.page-footer').outerHeight(true)
            - $('#ribbon').outerHeight(true)
            - 25
    }

    //格式化 日期
    function date_formatter(date) {
        return date.year + "-" + date.monthValue + "-" + date.dayOfMonth + " " + date.hour + ":" + date.minute + ":" + date.second;
    }

    //格式化enabled
    function enabledFormatter(enabled) {
        return enabled ? "<label class='label label-success'>是</label>" : "<label class='label label-danger'>否</label>";
    }


    // load related plugins


    loadScript("/static/js/libs/vue/axios.min.js", function () {
        loadScript("/static/js/libs/vue/vuerify.min.js", function () {
            loadScript("/static/js/libs/vue/url-search-params.min.js", page_function())
        })
    })


</script>
